---
title: "EmployeePromotion"
output:
  pdf_document: default
  html_document: default
date: "2023-02-18"
---

Poner aquí documentación

Este proyecto está realizado por el grupo 3 formado por José Arturo Espaillat, Johnsiel Castaños, José Delgado, Salama Mohamed-fadel Sidna. El dataset elegido es llamado HR Analytics: Employer Promotion Data (https://www.kaggle.com/datasets/arashnic/hr-ana?select=test.csv) sacado de Kaggle, el cual cuenta con X columnas y X filas para analizar si un empleado será o no promocionado. Hablar más de esto, mirar Rúbica

Para organizarnos, hemos decidido crear un repositorio en GitHub (https://github.com/Josdelser/DataScienceEmployeePromotion/tree/develop) para trabajar simultáneamente. También hemos creado una bolsa de preguntas y las hemos asignado según las capacidades y aspiraciones de cada persona. En el caso de que algún miembro quiera obtener una calificación más alta, deberá realizar un mayor número de preguntas individuales. Todos los miembros realizarán una pregunta para la parte grupal y se ha intentado que estas preguntas estén relacionadas con las preguntas individuales, para poder afrontar mejor el reto. A continuación, se detalla la bolsa de preguntas y la asignación de cada miembro.


Jose Delgado:

  -Grupal
  
    ¿Como predecir si será promovido un empleado?
    
    
  -Individual:
    
    ¿Nos puede ayudar la visualización a sacar conclusiones temprana?
    
    ¿Habrá diferencias respecto a predecir con regresion logistica?
    
    ¿correlacion tetraconica para ver correlacion entre variables booleanas
correlacion cramer o maxwell
one-hot encoding para correlacion booleana?

    
    ¿Quitando variables mejorará el arbol?
    
Salama:
Johnsiel:
Jose Espaillat:
    
    
Cada miembro realizará la documentación de ambas partes asignadas. Además en el documento se indicará donde empieza y acaba la parte de cada miembro para que así sea mas sencilla su evaluación. 

```{r}
library(dplyr)
library(rpart)
library(rpart.plot)
library(caret)
library(rpart)
library(rpart.plot)
library(rattle)
library(dplyr)
library(ggplot2)
library(RColorBrewer)
library(caret)
library(ggfortify)
library(readr)
library(factoextra)


require(corrplot)


set.seed(28)
```


Información general del Dataset

```{r}
data<- read.csv("train.csv")
data <- rename(data, awards_won = awards_won.)
head(data)
colnames(data)
attach(data)
```

```{r}
str(data)
dim(data)
object.size(data)/1024
```

```{r}
print(paste("Número de valores faltantes totales:", sum(is.na(data))))
data <- na.omit(data)
data <- unique(data)

```
*Aquí empieza la parte de Jose Delgado

Una vez cargado el dataset y tratado minimamente vamos a pasar a hacer responder a las preguntas, primero la pregunta grupal:

¿Como predecir si será promovido un empleado?

La cual se plantea responder mediante una predicción utilizando validacion cruzada (cross_validation), para ello podemos tirar de regresión lógistica o un árbol de decisión. En este caso usaré arboles de decisión para así también ver que variables inlfuyen y poder comparar este resultado con las preguntas individuales 


Primero le hacemos preprocesamiento de manera preparatoria a la prediccion, luego dividimos el dataset en conjunto de prueba(test) y entrenamiento(train) para obtener resultado
```{r}
dep_levels <- unique(data$department)
gen_levels <- unique(data$gender)
recru_levels <- unique(data$recruitment_channel)
promo_levels <- unique(data$is_promoted )


data$department <- factor(data$department, levels = dep_levels)
data$gender  <- factor(data$gender , levels = gen_levels)
data$recruitment_channel <- factor(data$recruitment_channel, levels = recru_levels)
data$is_promoted <- factor(data$is_promoted, levels = promo_levels)

```




```{r}
division <- createDataPartition(data$is_promoted, p = .7, list = FALSE, times = 1)
train <- data[division, ]
test  <- data[-division, ]
```

Entrenamos el modelo y visualizamos para tener una primera imagen de las variables decisivas 

```{r}
arbol <- rpart(formula =  is_promoted  ~ ., data = train, method = 'class')

fancyRpartPlot(arbol)
```



Podemos observar que la variable que mas afecta es la puntuación en el rango superior a 91, donde con un 99% de posibilidades seras promocionado. AL tener una variable con tanta importancia se nos viene a la cabeza otra pregunta: Quitando esta variable, ¿Como sería el arbol final?. Se plantea segunda pregunta

Pasamos a predecir según clasifacación 

```{r}
prediccion <-predict(arbol, test, type = "class")
```
 
Ahora toca evaluar el rendimiento según validación cruzada. 

```{r}
valcruz <- trainControl(method = "cv", number = 10)

arbolfit <- train(is_promoted ~ ., data = train, method = "rpart",
                 trControl = valcruz, tuneLength = 10)
```

Graficamos

```{r}
rpart.plot(arbolfit$finalModel, type = 2, extra = 1)

```

Mejoras visualizacion
```{r}
prp(arbolfit$finalModel, type = 2, nn = TRUE, 
    fallen.leaves = FALSE,
    varlen = 0,  shadow.col = "gray")
```
```{r}
prediccionTest <- predict(arbolfit, newdata = test)
confusionMatrix(prediccionTest, test$is_promoted)
```


Jose preguntas individuales



un analisis exploratorio para ver por donde van los tiros antes de hacer la prediccion y así ver variables que puedan afectar directamente.

Primero vamos a ver las proporciones de las variables. En la caso de las numericas vamos a sacar informacion estadistica como la mediana, max, min... En el caso de las categoricas veremos el numeros de observaciones según las categorias de la variable

```{r}
summary(data)
```

```{r}
table(data$department)
table(data$region)
table(data$education)
table(data$gender)
table(data$recruitment_channel)
table(data$awards_won)

```
Aqui poner conclusiones según esto
```{r}
# Calcular la correlación
correlation_matrix <- cor(data[,c("no_of_trainings", "age", "previous_year_rating", "length_of_service", "awards_won?", "avg_training_score", "is_promoted")])

# Visualizar la matriz de correlación
library(corrplot)
corrplot(correlation_matrix, method="color", type="upper", order="hclust")
```



* Aquí empieza la parte de Salama
* Aquí empieza la parte de Johnsiel
* Aquí empieza la parte de Jose Espaillat


## ¿Existe asociación entre el género y la promoción de los empleados en cada departamento de la empresa?

```{r}
#Cargar datos
data_josea<- read.csv("train.csv")
head(data_josea)
```

```{r}
#Vistazo rapido los datos
glimpse(data_josea)
summary(data_josea)
```

```{r}
dep_levels <- unique(data_josea$department)
gen_levels <- unique(data_josea$gender)
promo_levels <- unique(data_josea$is_promoted )

data_josea$department <- factor(data_josea$department, levels = dep_levels)
data_josea$gender  <- factor(data_josea$gender , levels = gen_levels)
data_josea$is_promoted <- factor(data_josea$is_promoted, levels = promo_levels)
```

```{r}
print(paste("Número de valores faltantes totales:", sum(is.na(data_josea))))
data_josea <- na.omit(data_josea)
data_josea <- unique(data_josea)
```

**Gráficos:**

Para responder a esta pregunta, empezaremos con graficar los datos releavantes para este análisis:

```{r}
#Graficamos Empleados Promovidos
ggplot(data_josea, aes(x = is_promoted, fill=is_promoted)) +
  geom_bar() +
  labs(title = "Empleados Promovidos", x = "Promovido", y = "Empleados")

#Graficamos Empleados Promovidos por Departamento
ggplot(data_josea, aes(x = department, fill=is_promoted)) +
  geom_bar(position = "dodge") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Empleados Promovidos por Departamento", x = "Departamento", y = "Empleados")
```

Como es de esperar, la cantidad de empleados que son promovidos en la empresa es mucho menor que los que no lo son.

A simple vista no parece haber un departamento cuya proporción de empleados promovidos es mucho mayor con respecto a los demás.

Veamos la proporción del género de los empleados por departamento:

```{r}
#Graficamos Género de los Empleados por Departamento
ggplot(data_josea, aes(x = department, fill=gender)) +
  geom_bar(position = "dodge") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Género de los Empleados por Departamento", x = "Departamento", y = "Empleados")
```

Para llevar a cabo este análisis es importante conocer el género de los empleados de cada departamento en la empresa.

De manera general, podemos observar que en todos los departamentos figuran más hombres que mujeres, destacando de manera particular los departamentos "Sales & Marketing", "Analytics", "R&D" y "Finance" por ser los que parecen tener un mayor desbalance en cuanto a género.

Sabiendo esto procedemos mostrar la proporcion de empleados promovidos por genero y por departamento

```{r}
# Calculamos la proporción de empleados promovidos por género y por departamento
promotion_prop <- aggregate(cbind(prop = is_promoted) ~ department + gender, data_josea = subdata, FUN = mean)

# Graficamos Proporción de Empleados Promovidos por genero y por departamento
ggplot(promotion_prop, aes(x = department, y = prop, fill = gender)) +
  geom_col(position = "dodge") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Proporción de Empleados Promovidos por Género y por Departamento", x = "Departamento", y = "Proporción Promovida")
```

Al mostrar gráficamente la proporción de empleados promovidos por género en cada departamento, podemos observar un aparente balance en casi todos los departamentos con excepción de "Analytics", "R&D" y "Procurement", sin embargo, de manera visual aun no podemos llegar a ninguna conclusión certera.

**Prueba de hipótesis:**

A continuación realizaremos un análisis estratificado, para comparar la proporción de empleados promovidos por género dentro de cada estrato (departamento):

```{r}
# Creamos un subset de los datos con las columnas relevantes para este análisis
subdata <- data_josea[, c("department", "gender", "is_promoted")]
estratos <- unique(subdata$department)

estratos
```

Haremos un test de independencia chi-cuadrado para determinar si existe una asociación significativa entre el género y el estatus de promoción del empleado, donde:

-   H0 - No existe asociación entre el género y la promoción de los empleados

-   HA - Existe asociación entre el género y la promoción de los empleados

```{r}
# Creamos vectores para almacenar los resultados
chi_square <- numeric(length(estratos))
p_value <- numeric(length(estratos))
```

Para realizar el test de chi-cuadrado, es necesario construir una tabla de contingencia que muestre las frecuencias observadas de hombres y mujeres promovidos y no promovidos, y calcular las frecuencias esperadas suponiendo que no haya asociación entre el género y el estado de promoción. Luego se calcula la estadística chi-cuadrado, que mide la diferencia entre las frecuencias observadas y la esperadas.

```{r}
# Hacemos loop sobre cada estrato para realizar los test para cada departamento

for (i in seq_along(estratos)) {
  # Crear subset de los datos para el estrato actual
  data_estrato <- subdata[subdata$department == estratos[i], ]
  
  # Crear tabla de contingencia
  tabla_promo <- table(data_estrato$is_promoted, data_estrato$gender)
  
  # Test de independencia chi-cuadrado
  result <- chisq.test(tabla_promo)
  
  # Almacenar los resultados
  chi_square[i] <- result$statistic
  p_value[i] <- result$p.value
}

# Combinar los resultados y print
resultados <- data.frame(estratos, chi_square, p_value)

print(resultados)
```

Análizando los valores de p-value obtenidos para cada estrato (departamento) luego de aplicar el test de independencia chi-cuadrado, podemos concluir lo siguiente:

Los departamentos "Operations", "Technology", "R&D", "Finance", "HR" y "Legal" obtuvieron un p-value \> 0.05, por lo que fallamos en rechazar la hipotesis nula.

Por otro lado, para los departamentos "Sales & Marketing", "Analytics" y "Procurement" se obtuvo un p-value \< 0.05, por lo que rechasamos la hipotesis nula y concluimos que, para estos departamentos, sí existe asociación entre el género y la promoción de los empleados.

Es importante tener en cuenta que una asociación significativa entre el género y la promoción del empleado no implica necesariamente causalidad. Es posible que haya otros factores que contribuyan a las diferencias observadas.
